# asm-vscode-template

このリポジトリは、GNU Assembler (GAS) を使った x86-64 アセンブリ開発を VS Code で始めるためのテンプレートです。VS Code のタスク機能と GDB を組み合わせて、1 つのショートカットからビルドとデバッグを行えます。

## セットアップ手順

1. **リポジトリを入手する**  
   - GitHub からダウンロードする場合は、リポジトリのページで `Code` ▶ `Download ZIP` を選択し、任意のフォルダに展開してください。  
   - Git を使う場合は、VS Code を開いて左のサイドバーからソース管理アイコンを押し、`リポジトリのクローン…` を選択して URL を貼り付けます (VS Code がクローン後にフォルダを開くか聞いてきます)。
2. **VS Code でフォルダを開く**  
   `ファイル` ▶ `フォルダーを開く...` を選び、展開またはクローンしたフォルダを指定します。フォルダを開くと `.vscode` 配下の設定が自動で読み込まれます。
3. **必要なツールを確認する**  
   `表示` ▶ `ターミナル` で統合ターミナルを開き、以下を実行してインストール済みか確認します。未インストールの場合は、macOS なら Homebrew (`brew install gcc gdb`)、Ubuntu/WSL なら `sudo apt install build-essential gdb` を利用してください。  
   ```bash
   gcc --version
   gdb --version
   ```
4. **リモートリポジトリを消す (任意)**  
   Git を使ってクローンした場合、元のリポジトリ（私のもの）へのリンクが残っています。新しいプロジェクトとして始める場合は、以下のコマンドで削除してください。  
   ```bash
   git remote remove origin
   ```
4. **VS Code 拡張機能 (任意)**  
   左の拡張機能アイコンから "C/C++" (ms-vscode.cpptools) を検索し、`インストール` をクリックするとアセンブリでもシンボル情報や簡易補完が得られます。

## オプション: ショートカットでタスクを起動する

既定ではタスクをメニューから呼び出せますが、`Ctrl + Alt + G` などのショートカットを割り当てると素早く実行できます。任意で以下の手順に従って設定してください。

1. VS Code 上部の `Ctrl + K` → `Ctrl + S` (または `ファイル` ▶ `ユーザー設定` ▶ `キーボード ショートカット`) を押してショートカット設定画面を開きます。
2. 右上にある `{}` アイコンをクリックして JSON 形式の `keybindings.json` を開きます。
3. 次の設定を追加し、`Ctrl + Alt + G` にタスク起動を割り当てます。macOS では同じ組み合わせで `⌃⌥G` になります。
   ```json
   {
     "key": "ctrl+alt+g",
     "command": "workbench.action.tasks.runTask",
     "args": "Run: assemble + gdb",
     "when": "resourceExtname == .s && !inDebugMode"
   }
   ```
4. ショートカットを変更したい場合は `"key"` の内容を好みの組み合わせに書き換え、保存してください。VS Code は保存後すぐに新しいショートカットを反映します。

## 使い方

1. **アセンブリコードを編集する**  
   あなたが編集したい `.s` ファイルを開き、コードを書きます。例として `sample/add5.s` を用意しています。
2. **タスクを実行する**  
   - メニュー経由: `ターミナル` ▶ `タスクの実行...` ▶ `Run: assemble + gdb` を選択します。  
   - ショートカットを設定している場合は `Ctrl + Alt + G` を押します。
3. **ビルドの完了を確認する**  
   下部にビルドのログが流れ、エラーがなければそのまま GDB が起動します。エラーが表示された場合は該当行を確認し、修正後にもう一度タスクを実行してください。
4. **GDB TUI でデバッグする**  
   GDB が立ち上がります。初期状態で `sample/add5.o` バイナリが読み込まれているので、以下のように入力してステップ実行できます。  
   ```
   (gdb) start        # main の先頭まで進む
   (gdb) ni           # 次の命令へ
   (gdb) info registers
   ```
   GDBの基本操作については別途のサイトなどを参照してください。
5. **デバッグ終了**  
   GDB を終了するには `(gdb) quit` を入力し、`y` を押して確定します。VS Code のターミナル画面も不要であれば右上のゴミ箱アイコンで閉じてください。

## GDBの設定を常に読み込む
GDBにはさまざまな設定ができます。GDBコマンドを起動するたびに設定を手動で入力するのは面倒なので、ホームディレクトリに `.gdbinit` ファイルを作成し、よく使うコマンドを記述しておくと適応してくれます。このファイルは`~/.gdbinit`に配置します。`~/`はユーザーのホームディレクトリを指します。
例えば以下のような内容が考えられます。（私の設定です）

```gdb
# ~/.gdbinit
set disassembly-flavor att
set disassemble-next-line on

tui new-layout asmreg regs 1 asm 3 status 0 cmd 1                   # レジスタとアセンブリを縦に並べる
tui new-layout asmregs {-horizontal regs 1 asm 1} 2 status 0 cmd 1  # レジスタとアセンブリを横に並べる
layout asmregs
```

なお、`layout asm`（アセンブリ表示）コマンドはここに書いても-私の環境では-効果がなかったので、`tui new-layout`でレイアウトを定義しています。定義したレイアウトは`layout asmreg`や`layout asmregs`で呼び出せます。`adb`が起動したのちに`layout asmregs`と入力すれば、アセンブリとレジスタを同時に表示できます。

## トラブルシューティング

- **`gcc` や `gdb` が見つからない**: ターミナルで `which gcc` / `which gdb` を実行し、場所が表示されない場合はインストールされていません。OS に応じてパッケージマネージャーから導入してください。インストール後に VS Code を再起動すると PATH が認識されやすくなります。
- **タスクが表示されない**: フォルダを正しく開いているか確認してください。ワークスペースのルート直下に `.vscode/tasks.json` がある状態で開く必要があります。
- **ショートカットが効かない**: すでに別のコマンドに割り当て済みの組み合わせかもしれません。ショートカット設定画面で重複がないか確認し、必要に応じて別のキーに変更してください。

## ライセンス
このリポジトリは MIT ライセンスの下で公開されています。詳細は `LICENSE` ファイルを参照してください。
